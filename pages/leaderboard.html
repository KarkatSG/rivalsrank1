<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Leaderboard</title>
  <link rel="stylesheet" href="../css/styles.css" />
</head>

<body>
  <h1 id="hero-name"></h1>
  <h2 id="description"></h2>
  <a href="index.html" class="back-btn">
    <img src="../images/button.png" alt="More Heroes Button" class="hero-select-btn">
  </a>

  <div class="leaderboard-container" style="display: none;">
    <table id="leaderboard">
      <thead>
        <tr>
          <th>Rank</th>
          <th>Player</th>
          <th>Rank</th>
          <th>Elo</th>
          <th>Matches</th>
        </tr>
      </thead>
      <tbody>
        <!-- Dynamically injected rows -->
      </tbody>
    </table>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  
  <script>
    window.onload = async () => {
      const { createClient } = window.supabase;
      const supabase = createClient(
        "https://bqffurypbsbmcuvlsmll.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJxZmZ1cnlwYnNibWN1dmxzbWxsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzY3MjQ2MTQsImV4cCI6MjA1MjMwMDYxNH0.QQKl807jEVhOhlCzItIu_Z240LI9mFU0-h0TOFBTTis"
      );

      console.log("Supabase Instance: ", supabase);

      // Function to format hero name from URL
      function formatHeroName(hero) {
        return hero
          .split("-") 
          .map(word => word.charAt(0).toUpperCase() + word.slice(1)) 
          .join(" ");
      }

      // Mapping rank names to icon file paths
      const rankIcons = {
        Bronze: "../images/Bronze.png",
        Silver: "../images/Silver.png",
        Gold: "../images/Gold.png",
        Platinum: "../images/Platinum.png",
        Diamond: "../images/Diamond.png",
        Grandmaster: "../images/Grandmaster.png",
        Celestial: "../images/Celestial.png",
        Eternity: "../images/Eternity.png",
        OneAboveAll: "../images/OneAboveAll.png"
      };

      async function fetchLeaderboard(heroName) {
        try {
          const { data, error } = await supabase
            .from("leaderboards")
            .select("*")
            .eq("character_name", heroName)
            .order("rank", { ascending: true });

          if (error) {
            console.error("Error fetching leaderboard:", error);
            return [];
          }
          return data;
        } catch (err) {
          console.error("Unexpected error fetching leaderboard:", err);
          return [];
        }
      }

      function getIconForRank(rankName) {
        // Matches partial rank names (e.g., "Bronze I" -> "Bronze" key)
        const baseRank = Object.keys(rankIcons).find(base => rankName.includes(base));
        return baseRank ? rankIcons[baseRank] : "../images/default-icon.png";
      }

      function renderLeaderboard(data) {
        const tbody = document.querySelector("#leaderboard tbody");
        tbody.innerHTML = "";

        data.forEach((entry, index) => {
          // Create the row as before
          const row = document.createElement("tr");

          // Build row.innerHTML with your rank/player data ...
          const iconPath = getIconForRank(entry.rank_name);
          row.innerHTML = `
            <td>${entry.rank}</td>
            <td>
              <img src="${iconPath}" alt="${entry.rank_name} Icon" class="rank-icon">
              ${entry.player_name}
            </td>
            <td>${entry.rank_name}</td>
            <td>${entry.score}</td>
            <td>${entry.matches}</td>
          `;

          if (index < 20) {
            row.classList.add("fade-in-row");
            row.style.animationDelay = `${index * 0.1 + 1.2}s`;
          }
          
          tbody.appendChild(row);
        });
      }

      // Grab hero from URL, format it, and fetch data
      const urlParams = new URLSearchParams(window.location.search);
      const rawHero = urlParams.get("hero");
      const formattedHero = formatHeroName(rawHero);

      const h1 = document.getElementById("hero-name");
      const h2 = document.getElementById("description");
      h1.classList.add("fade-in-element");
      h2.classList.add("fade-in-element");
      h1.style.animationDelay = "0s";

      const data = await fetchLeaderboard(formattedHero);

      h1.textContent = `${formattedHero} Leaderboard`;
      h2.textContent = `Showing top ${formattedHero} players with at least 30 matches played.`;


      const container = document.querySelector(".leaderboard-container");
      container.style.display = "block";
      container.classList.add("fade-in-element");
      container.style.animationDelay = "0.6s";

      renderLeaderboard(data);
    };
  </script>
</body>
</html>
